# XCode Membership 权限管理模块

XCode Membership 是 XCode ORM 框架内置的用户权限管理模块，提供完整的 RBAC（基于角色的访问控制）实现，支持多租户 SaaS 场景。

## 目录

- [模块概述](#模块概述)
- [核心表结构](#核心表结构)
- [RBAC 权限模型](#rbac-权限模型)
- [多租户设计](#多租户设计)
- [数据权限](#数据权限)
- [枚举类型](#枚举类型)
- [使用示例](#使用示例)

---

## 模块概述

### 设计原则

1. **精简实用**：避免过度设计，不使用 UserRole/RoleMenu 关联表，采用逗号分隔字段存储
2. **灵活扩展**：每个表都有 Ex1~Ex6 扩展字段，供业务自定义使用
3. **多租户支持**：用户全局，先登录再选租户，通过 TenantUser 实现租户隔离
4. **数据权限**：角色级别的数据范围控制（全部/本部门及下级/本部门/仅本人/自定义）

### 表关系图

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│  User   │────?│  Role   │────?│  Menu   │
└─────────┘     └─────────┘     └─────────┘
     │               │               │
     │               │               │
     ▼               ▼               │
┌─────────┐     ┌─────────┐         │
│Department│?───│ Tenant  │         │
└─────────┘     └─────────┘         │
     ▲               │               │
     │               ▼               │
     │         ┌───────────┐        │
     └─────────│TenantUser │        │
               └───────────┘        │
                                    │
┌─────────┐     ┌─────────┐        │
│Parameter│     │   Log   │?───────┘
└─────────┘     └─────────┘
                    
┌─────────┐
│  Area   │
└─────────┘
```

---

## 核心表结构

### User（用户）

用户账号信息，以身份验证为中心，拥有多种角色，可加入多个租户。

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | Int32 | 编号（主键） |
| Name | String | 登录用户名（唯一） |
| Password | String | 密码（格式：`$算法$盐值$散列`） |
| DisplayName | String | 昵称 |
| Sex | SexKinds | 性别（未知/男/女） |
| Mail | String | 邮件（支持登录） |
| Mobile | String | 手机（支持登录） |
| Code | String | 代码（身份证、员工编码等，支持登录） |
| RoleID | Int32 | 主要角色 |
| RoleIds | String | 次要角色集合（逗号分隔） |
| DepartmentID | Int32 | 部门 |
| Enable | Boolean | 启用 |

**密码存储格式**：
```
$sha512$7g4mapGnOmxt5/4x$uDIMCTcWe0WqL3EUPAGdET2gaxCGkierhoSnIJIve/8+...
```
包含：算法名称、盐值、散列值，便于支持多种加密算法。

### Department（部门）

组织机构，多级树状结构，支持多租户。

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | Int32 | 编号（主键） |
| TenantId | Int32 | 租户 |
| Type | DepartmentTypes | 类型（公司/部门/小组/虚拟） |
| Code | String | 代码 |
| Name | String | 名称 |
| FullName | String | 全名 |
| ParentID | Int32 | 父级 |
| Level | Int32 | 层级 |
| ManagerId | Int32 | 管理者 |
| Enable | Boolean | 启用 |

### Role（角色）

业务场景中的岗位，功能权限的集合。

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | Int32 | 编号（主键） |
| Name | String | 名称 |
| Type | RoleTypes | 类型（系统/普通/租户） |
| Enable | Boolean | 启用 |
| IsSystem | Boolean | 系统角色（不受数据权限约束） |
| TenantId | Int32 | 租户（0表示全局角色） |
| DataScope | DataScopes | 数据范围 |
| DataDepartmentIds | String | 自定义数据权限部门列表 |
| Permission | String | 权限（逗号分隔，每个资源的权限子项竖线分隔） |

### Menu（菜单）

功能权限，大多数时候也是可见页面。

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | Int32 | 编号（主键） |
| Name | String | 名称 |
| DisplayName | String | 显示名 |
| Type | MenuTypes | 类型（目录/菜单/功能） |
| ParentID | Int32 | 父编号 |
| Url | String | 链接 |
| Icon | String | 图标 |
| Visible | Boolean | 可见 |
| Permission | String | 权限子项（逗号分隔，名值竖线分隔） |

### Tenant（租户）

多租户 SaaS 平台，用于隔离业务数据。

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | Int32 | 编号（主键） |
| Code | String | 编码（唯一） |
| Name | String | 名称 |
| Type | TenantTypes | 类型（免费/个人/企业/旗舰） |
| Enable | Boolean | 启用 |
| Level | Int32 | 等级（数字越大功能越多） |
| ManagerId | Int32 | 管理者 |
| RoleIds | String | 可选角色集合 |
| Domain | String | 绑定的独立域名 |
| MaxUsers | Int32 | 用户数上限（0不限制） |
| MaxStorage | Int64 | 存储上限（字节，0不限制） |
| Expired | DateTime | 过期时间 |

### TenantUser（租户关系）

用户选择租户进入系统后，以租户关系角色组替代自有角色组来进行鉴权。

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | Int32 | 编号（主键） |
| TenantId | Int32 | 租户 |
| UserId | Int32 | 用户 |
| Enable | Boolean | 启用 |
| DepartmentId | Int32 | 部门（用户在该租户的部门） |
| RoleId | Int32 | 主要角色（替换用户自身角色） |
| RoleIds | String | 次要角色集合 |

### Parameter（字典参数）

管理用户或系统全局的名值对数据，常用于参数配置场合。

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | Int32 | 编号（主键） |
| UserID | Int32 | 用户（0表示系统级） |
| Category | String | 类别 |
| Name | String | 名称 |
| Value | String | 数值 |
| LongValue | String | 长数值 |
| Kind | ParameterKinds | 种类（普通/列表/名值） |

### Log（日志）

应用系统审计日志，记录用户的各种操作，禁止修改和删除。

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | Int64 | 编号（主键，时间戳） |
| Category | String | 类别 |
| Action | String | 操作 |
| LinkID | Int64 | 链接 |
| Success | Boolean | 成功 |
| UserName | String | 用户名 |
| TraceId | String | 性能追踪 |
| CreateIP | String | 创建地址 |
| Remark | String | 详细信息 |

### Area（地区）

行政区划数据，最高支持四级地址。

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | Int32 | 行政区划编码（主键） |
| Name | String | 名称 |
| FullName | String | 全名 |
| ParentID | Int32 | 父级 |
| Level | Int32 | 层级 |
| PinYin | String | 拼音 |
| GeoHash | String | 地址编码 |

---

## RBAC 权限模型

### 权限层次

```
用户 (User)
  │
  ├── 主要角色 (RoleID)
  │
  └── 次要角色 (RoleIds) ──逗号分隔──? 角色1, 角色2, 角色3
                                          │
                                          ▼
                                    功能权限 (Permission)
                                          │
                                          ▼
                                    菜单 + 权限子项
```

### 功能权限存储

**Role.Permission** 字段格式：
```
菜单ID#权限值,菜单ID#权限值,...
```

示例：`12#31,15#7,18#1`

**权限值**（位标识）：
| 值 | 权限 |
|---|------|
| 1 | 查看 |
| 2 | 添加 |
| 4 | 编辑 |
| 8 | 删除 |
| 16 | 导入 |
| 32 | 导出 |

### 菜单权限子项

**Menu.Permission** 字段格式：
```
权限名|权限值,权限名|权限值,...
```

示例：`查看|1,添加|2,编辑|4,删除|8,审核|256`

### 角色类型

| 类型 | 值 | 说明 |
|------|---|------|
| 系统 | 0 | 系统内置角色，只有管理员可见/可分配 |
| 普通 | 1 | 普通业务角色，可分配给用户 |
| 租户 | 2 | 租户专属角色，仅在租户内生效 |

---

## 多租户设计

### 设计理念

- **用户全局**：User 表不属于任何租户，用户先登录再选择租户
- **租户隔离**：通过 TenantUser 表实现用户与租户的关联
- **角色替换**：进入租户后，使用 TenantUser 中的角色替代用户自身角色

### 登录流程

```
1. 用户登录（验证 User 表）
       │
       ▼
2. 查询用户所属租户列表（TenantUser）
       │
       ▼
3. 用户选择租户
       │
       ▼
4. 加载租户角色和部门（TenantUser.RoleId, DepartmentId）
       │
       ▼
5. 进入系统，使用租户角色进行鉴权
```

### 租户配额

| 字段 | 说明 |
|------|------|
| MaxUsers | 最大用户数限制 |
| MaxStorage | 最大存储空间限制 |
| Expired | 过期时间，到期自动禁用 |
| Level | 租户等级，控制功能开放范围 |

---

## 数据权限

### 数据范围

通过 **Role.DataScope** 控制用户可访问的数据范围：

| 值 | 名称 | 说明 |
|---|------|------|
| 0 | 全部 | 可访问所有数据（超管） |
| 1 | 本部门及下级 | 本部门及所有下级部门的数据 |
| 2 | 本部门 | 仅本部门数据 |
| 3 | 仅本人 | 只能看自己创建的数据 |
| 4 | 自定义 | 指定部门列表（DataDepartmentIds） |

### 使用示例

```csharp
/// <summary>根据当前用户角色构建数据权限过滤条件</summary>
public static WhereExpression BuildDataScope<T>(IUser user) where T : Entity<T>
{
    var role = user.Role;
    if (role == null || role.IsSystem) return null; // 系统角色不受限制

    var exp = new WhereExpression();

    switch ((DataScopes)role.DataScope)
    {
        case DataScopes.全部:
            return null;
            
        case DataScopes.本部门及下级:
            // 获取本部门及所有下级部门ID
            var deptIds = Department.FindByID(user.DepartmentID)?.GetAllChildIds();
            return Entity<T>._.DepartmentID.In(deptIds);
            
        case DataScopes.本部门:
            return Entity<T>._.DepartmentID == user.DepartmentID;
            
        case DataScopes.仅本人:
            return Entity<T>._.CreateUserID == user.ID;
            
        case DataScopes.自定义:
            // 使用自定义部门列表
            var customDepts = role.DataDepartmentIds?.SplitAsInt(",");
            return Entity<T>._.DepartmentID.In(customDepts);
    }
    
    return null;
}
```

---

## 枚举类型

### DepartmentTypes（部门类型）

```csharp
public enum DepartmentTypes
{
    公司 = 0,   // 顶级组织
    部门 = 1,   // 标准部门
    小组 = 2,   // 部门下的团队
    虚拟 = 3    // 虚拟组织（如项目组）
}
```

### RoleTypes（角色类型）

```csharp
public enum RoleTypes
{
    系统 = 0,   // 系统内置角色
    普通 = 1,   // 普通业务角色
    租户 = 2    // 租户专属角色
}
```

### DataScopes（数据范围）

```csharp
public enum DataScopes
{
    全部 = 0,           // 可访问所有数据
    本部门及下级 = 1,   // 本部门及下级部门
    本部门 = 2,         // 仅本部门
    仅本人 = 3,         // 仅自己的数据
    自定义 = 4          // 自定义部门列表
}
```

### MenuTypes（菜单类型）

```csharp
public enum MenuTypes
{
    目录 = 0,   // 菜单容器，不可点击
    菜单 = 1,   // 可点击的菜单项
    功能 = 2    // 功能点（权限子项在 Permission 字段）
}
```

### TenantTypes（租户类型）

```csharp
public enum TenantTypes
{
    免费 = 0,   // 免费版
    个人 = 1,   // 个人版
    企业 = 2,   // 企业版
    旗舰 = 3    // 旗舰版
}
```

### SexKinds（性别）

```csharp
public enum SexKinds
{
    未知 = 0,
    男 = 1,
    女 = 2
}
```

### ParameterKinds（参数种类）

```csharp
public enum ParameterKinds
{
    普通 = 0,
    列表 = 21,
    名值 = 22
}
```

---

## 使用示例

### 用户认证

```csharp
// 通过用户名密码登录
var user = User.FindByName(username);
if (user != null && user.Enable)
{
    // 验证密码（内置支持 $算法$盐值$散列 格式）
    if (user.CheckPassword(password))
    {
        // 登录成功
    }
}

// 支持多种登录方式
var user = User.FindByName(account)      // 用户名
        ?? User.FindByMail(account)      // 邮箱
        ?? User.FindByMobile(account)    // 手机
        ?? User.FindByCode(account);     // 员工编码
```

### 权限检查

```csharp
// 检查用户是否有某菜单的某权限
var user = ManageProvider.User;
var hasPermission = user.Role.Has(menuId, PermissionFlags.Edit);

// 检查多个角色的权限（主角色 + 次要角色）
var roles = user.GetRoles();
var canEdit = roles.Any(r => r.Has(menuId, PermissionFlags.Edit));
```

### 多租户切换

```csharp
// 获取用户所属租户列表
var tenantUsers = TenantUser.FindAllByUserId(user.ID);
var tenants = tenantUsers.Select(tu => tu.Tenant).ToList();

// 切换到指定租户
var tenantUser = TenantUser.FindByTenantIdAndUserId(tenantId, user.ID);
if (tenantUser != null && tenantUser.Enable)
{
    // 使用租户角色
    var role = tenantUser.Role;
    var department = tenantUser.Department;
}
```

### 数据权限过滤

```csharp
// 在查询时自动追加数据权限条件
public IList<Order> GetOrders(Pager p)
{
    var user = ManageProvider.User;
    var exp = BuildDataScope<Order>(user);
    
    return Order.FindAll(exp, p);
}
```

---

## 扩展字段说明

每个表都预留了 Ex1~Ex6 扩展字段，供业务系统自定义使用：

| 字段 | 类型 | 建议用途 |
|------|------|---------|
| Ex1 | Int32 | 整数扩展（如状态码、计数器） |
| Ex2 | Int32 | 整数扩展（如外键引用） |
| Ex3 | Double | 浮点扩展（如金额、比例） |
| Ex4 | String | 字符串扩展（如附加信息） |
| Ex5 | String | 字符串扩展（如JSON数据） |
| Ex6 | String | 字符串扩展（不序列化） |

---

## 数据库连接

Membership 模块使用两个数据库连接：

- **Membership**：用户、角色、菜单、部门等核心数据
- **Log**：审计日志（独立连接，便于分库）

配置示例：
```xml
<connectionStrings>
  <add name="Membership" connectionString="Data Source=membership.db" providerName="SQLite" />
  <add name="Log" connectionString="Data Source=log.db" providerName="SQLite" />
</connectionStrings>
```

---

## 更新日志

### 2025.01

- 新增 `Department.Type` 字段，区分公司/部门/小组/虚拟
- 新增 `Role.Type` 字段，区分系统/普通/租户角色
- 新增 `Role.DataScope` 和 `Role.DataDepartmentIds` 字段，支持数据权限
- 新增 `Menu.Type` 字段，区分目录/菜单/功能
- 新增 `Tenant.Type`、`Level`、`Domain`、`MaxUsers`、`MaxStorage` 字段
- 新增 `TenantUser.DepartmentId` 字段，支持用户在不同租户属于不同部门
- 新增枚举：`DepartmentTypes`、`RoleTypes`、`DataScopes`、`MenuTypes`、`TenantTypes`

---

## 相关链接

- [XCode 文档](https://newlifex.com/xcode)
- [实体模型设计](https://newlifex.com/xcode/model)
- [GitHub 仓库](https://github.com/NewLifeX/NewLife.XCode)
- [Gitee 仓库](https://gitee.com/NewLifeX/NewLife.XCode)
