<Project>
  <!-- 在 NuGet 包还原后立即安装/更新 Copilot 指令文件 -->
  <!-- 监听 Restore 和 ResolvePackageAssets 目标，确保添加/更新包时立即执行 -->
  <Target Name="NewLifeXCode_InstallCopilotInstructions" 
          AfterTargets="Restore;ResolvePackageAssets" 
          Condition="'$(DesignTimeBuild)' != 'true'">
    <PropertyGroup>
      <!-- 源文件位于 NuGet 包的 content 目录 -->
      <_NewLifeXCode_CopilotInstructions_Source>$(MSBuildThisFileDirectory)..\content\.github\instructions\xcode.instructions.md</_NewLifeXCode_CopilotInstructions_Source>

      <!-- 优先查找 Git 仓库根目录（向上查找 .git 目录） -->
      <_NewLifeXCode_CopilotInstructions_GitRoot>$([MSBuild]::GetDirectoryNameOfFileAbove('$(MSBuildProjectDirectory)', '.git'))</_NewLifeXCode_CopilotInstructions_GitRoot>
      <!-- 其次使用解决方案目录（从解决方案构建时 SolutionDir 会被设置） -->
      <_NewLifeXCode_CopilotInstructions_SlnRoot Condition="'$(_NewLifeXCode_CopilotInstructions_GitRoot)' == '' and '$(SolutionDir)' != '' and '$(SolutionDir)' != '*Undefined*'">$(SolutionDir.TrimEnd('\'))</_NewLifeXCode_CopilotInstructions_SlnRoot>
      <!-- 最终确定目标根目录：Git根目录 > 解决方案目录，找不到则跳过（避免在每个项目目录下生成） -->
      <_NewLifeXCode_CopilotInstructions_Root Condition="'$(_NewLifeXCode_CopilotInstructions_GitRoot)' != ''">$(_NewLifeXCode_CopilotInstructions_GitRoot)</_NewLifeXCode_CopilotInstructions_Root>
      <_NewLifeXCode_CopilotInstructions_Root Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' == '' and '$(_NewLifeXCode_CopilotInstructions_SlnRoot)' != ''">$(_NewLifeXCode_CopilotInstructions_SlnRoot)</_NewLifeXCode_CopilotInstructions_Root>

      <_NewLifeXCode_CopilotInstructions_DestDir Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' != ''">$(_NewLifeXCode_CopilotInstructions_Root)\.github\instructions\</_NewLifeXCode_CopilotInstructions_DestDir>
      <_NewLifeXCode_CopilotInstructions_DestFile Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' != ''">$(_NewLifeXCode_CopilotInstructions_DestDir)xcode.instructions.md</_NewLifeXCode_CopilotInstructions_DestFile>
    </PropertyGroup>

    <ItemGroup>
      <_NewLifeXCode_CopilotInstructions_SourceFile Include="$(_NewLifeXCode_CopilotInstructions_Source)" Condition="Exists('$(_NewLifeXCode_CopilotInstructions_Source)')" />
    </ItemGroup>

    <!-- 使用 ContinueOnError 避免文件被占用时阻塞构建 -->
    <ReadLinesFromFile File="$(_NewLifeXCode_CopilotInstructions_DestFile)" 
                       Condition="Exists('$(_NewLifeXCode_CopilotInstructions_DestFile)')"
                       ContinueOnError="true">
      <Output TaskParameter="Lines" ItemName="_NewLifeXCode_CopilotInstructions_ExistingLines" />
    </ReadLinesFromFile>

    <PropertyGroup>
      <_NewLifeXCode_CopilotInstructions_ExistingText>@(_NewLifeXCode_CopilotInstructions_ExistingLines, '&#xD;&#xA;')</_NewLifeXCode_CopilotInstructions_ExistingText>
      
      <!-- 先获取源文件和目标文件的最后修改时间 -->
      <_NewLifeXCode_CopilotInstructions_SourceTime Condition="Exists('$(_NewLifeXCode_CopilotInstructions_Source)')">$([System.IO.File]::GetLastWriteTime('$(_NewLifeXCode_CopilotInstructions_Source)').Ticks)</_NewLifeXCode_CopilotInstructions_SourceTime>
      <_NewLifeXCode_CopilotInstructions_DestTime Condition="Exists('$(_NewLifeXCode_CopilotInstructions_DestFile)')">$([System.IO.File]::GetLastWriteTime('$(_NewLifeXCode_CopilotInstructions_DestFile)').Ticks)</_NewLifeXCode_CopilotInstructions_DestTime>
      
      <!-- 判断是否需要复制：
           1. 目标文件不存在
           2. 目标文件存在且包含"新生命团队"（表示是从包安装的）且源文件比目标文件新
      -->
      <_NewLifeXCode_CopilotInstructions_ShouldCopy Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' != '' and !Exists('$(_NewLifeXCode_CopilotInstructions_DestFile)')">true</_NewLifeXCode_CopilotInstructions_ShouldCopy>
      <_NewLifeXCode_CopilotInstructions_ShouldCopy Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' != '' and Exists('$(_NewLifeXCode_CopilotInstructions_DestFile)') and $([System.String]::Copy('$(_NewLifeXCode_CopilotInstructions_ExistingText)').Contains('新生命团队')) and '$(_NewLifeXCode_CopilotInstructions_SourceTime)' &gt; '$(_NewLifeXCode_CopilotInstructions_DestTime)'">true</_NewLifeXCode_CopilotInstructions_ShouldCopy>
    </PropertyGroup>

    <MakeDir Directories="$(_NewLifeXCode_CopilotInstructions_DestDir)" 
             Condition="'$(_NewLifeXCode_CopilotInstructions_ShouldCopy)'=='true' and !Exists('$(_NewLifeXCode_CopilotInstructions_DestDir)')" />
    
    <!-- 使用 ContinueOnError 避免文件被占用时阻塞构建 -->
    <Copy SourceFiles="@(_NewLifeXCode_CopilotInstructions_SourceFile)" 
          DestinationFiles="$(_NewLifeXCode_CopilotInstructions_DestFile)" 
          OverwriteReadOnlyFiles="true" 
          SkipUnchangedFiles="false"
          Condition="'$(_NewLifeXCode_CopilotInstructions_ShouldCopy)'=='true' and Exists('$(_NewLifeXCode_CopilotInstructions_Source)')"
          ContinueOnError="true">
      <Output TaskParameter="DestinationFiles" ItemName="_NewLifeXCode_CopilotInstructions_CopiedFiles" />
    </Copy>

    <!-- 输出提示信息 -->
    <Message Text="NewLife.XCode: Copilot 指令文件已安装到 $(_NewLifeXCode_CopilotInstructions_DestFile)" 
             Condition="'@(_NewLifeXCode_CopilotInstructions_CopiedFiles)' != ''" 
             Importance="high" />
    <Message Text="NewLife.XCode: 未找到 Git 根目录或解决方案目录，跳过 Copilot 指令文件安装" 
             Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' == ''" 
             Importance="normal" />
  </Target>
</Project>
