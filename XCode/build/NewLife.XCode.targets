<Project>
<Target Name="NewLifeXCode_InstallCopilotInstructions" BeforeTargets="BeforeCompile" Condition="'$(DesignTimeBuild)' != 'true'">
  <PropertyGroup>
    <!-- 源文件位于 NuGet 包的 content 目录 -->
    <_NewLifeXCode_CopilotInstructions_Source>$(MSBuildThisFileDirectory)..\content\.github\instructions\xcode.instructions.md</_NewLifeXCode_CopilotInstructions_Source>

      <!-- 优先查找 Git 仓库根目录（向上查找 .git 目录） -->
      <_NewLifeXCode_CopilotInstructions_GitRoot>$([MSBuild]::GetDirectoryNameOfFileAbove('$(MSBuildProjectDirectory)', '.git'))</_NewLifeXCode_CopilotInstructions_GitRoot>
      <!-- 其次使用解决方案目录（从解决方案构建时 SolutionDir 会被设置） -->
      <_NewLifeXCode_CopilotInstructions_SlnRoot Condition="'$(_NewLifeXCode_CopilotInstructions_GitRoot)' == '' and '$(SolutionDir)' != '' and '$(SolutionDir)' != '*Undefined*'">$(SolutionDir.TrimEnd('\'))</_NewLifeXCode_CopilotInstructions_SlnRoot>
      <!-- 最终确定目标根目录：Git根目录 > 解决方案目录 > 项目目录 -->
      <_NewLifeXCode_CopilotInstructions_Root Condition="'$(_NewLifeXCode_CopilotInstructions_GitRoot)' != ''">$(_NewLifeXCode_CopilotInstructions_GitRoot)</_NewLifeXCode_CopilotInstructions_Root>
      <_NewLifeXCode_CopilotInstructions_Root Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' == '' and '$(_NewLifeXCode_CopilotInstructions_SlnRoot)' != ''">$(_NewLifeXCode_CopilotInstructions_SlnRoot)</_NewLifeXCode_CopilotInstructions_Root>
      <_NewLifeXCode_CopilotInstructions_Root Condition="'$(_NewLifeXCode_CopilotInstructions_Root)' == ''">$(MSBuildProjectDirectory)</_NewLifeXCode_CopilotInstructions_Root>

      <_NewLifeXCode_CopilotInstructions_DestDir>$(_NewLifeXCode_CopilotInstructions_Root)\.github\instructions\</_NewLifeXCode_CopilotInstructions_DestDir>
      <_NewLifeXCode_CopilotInstructions_DestFile>$(_NewLifeXCode_CopilotInstructions_DestDir)xcode.instructions.md</_NewLifeXCode_CopilotInstructions_DestFile>
    </PropertyGroup>

    <ItemGroup>
      <_NewLifeXCode_CopilotInstructions_SourceFile Include="$(_NewLifeXCode_CopilotInstructions_Source)" Condition="Exists('$(_NewLifeXCode_CopilotInstructions_Source)')" />
    </ItemGroup>

    <ReadLinesFromFile File="$(_NewLifeXCode_CopilotInstructions_DestFile)" Condition="Exists('$(_NewLifeXCode_CopilotInstructions_DestFile)')">
      <Output TaskParameter="Lines" ItemName="_NewLifeXCode_CopilotInstructions_ExistingLines" />
    </ReadLinesFromFile>

    <PropertyGroup>
      <_NewLifeXCode_CopilotInstructions_ExistingText>@(_NewLifeXCode_CopilotInstructions_ExistingLines, '
')</_NewLifeXCode_CopilotInstructions_ExistingText>
      <!-- 目标文件不存在时需要复制 -->
      <_NewLifeXCode_CopilotInstructions_ShouldCopy Condition="!Exists('$(_NewLifeXCode_CopilotInstructions_DestFile)')">true</_NewLifeXCode_CopilotInstructions_ShouldCopy>
      <!-- 目标文件存在且包含 XCode 标识时需要更新（说明是由本包释放的，可以覆盖） -->
      <_NewLifeXCode_CopilotInstructions_ShouldCopy Condition="Exists('$(_NewLifeXCode_CopilotInstructions_DestFile)') and $([System.String]::Copy('$(_NewLifeXCode_CopilotInstructions_ExistingText)').Contains('XCode'))">true</_NewLifeXCode_CopilotInstructions_ShouldCopy>
    </PropertyGroup>

    <MakeDir Directories="$(_NewLifeXCode_CopilotInstructions_DestDir)" Condition="'$(_NewLifeXCode_CopilotInstructions_ShouldCopy)'=='true' and !Exists('$(_NewLifeXCode_CopilotInstructions_DestDir)')" />
    <Copy SourceFiles="@(_NewLifeXCode_CopilotInstructions_SourceFile)" DestinationFiles="$(_NewLifeXCode_CopilotInstructions_DestFile)" OverwriteReadOnlyFiles="true" SkipUnchangedFiles="true" Condition="'$(_NewLifeXCode_CopilotInstructions_ShouldCopy)'=='true' and Exists('$(_NewLifeXCode_CopilotInstructions_Source)')" />
  </Target>
</Project>
